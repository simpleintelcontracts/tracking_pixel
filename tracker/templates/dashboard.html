{% load static %}
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Tracking Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://unpkg.com/modern-normalize/modern-normalize.css" rel="stylesheet">
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; padding: 24px; color:#0f172a; }
    .grid { display: grid; gap: 16px; }
    .grid-4 { grid-template-columns: repeat(4,minmax(0,1fr)); }
    .grid-3 { grid-template-columns: repeat(3,minmax(0,1fr)); }
    .grid-2 { grid-template-columns: repeat(2,minmax(0,1fr)); }
    .card { background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:16px; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .kpi { font-size: 14px; color:#475569; }
    .kpi .val { font-size: 28px; font-weight: 700; color:#0f172a; }
    .muted { color:#64748b; font-size: 12px; }
    h1 { font-size: 24px; margin: 0 0 16px; }
    h2 { font-size: 18px; margin: 0 0 12px; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { text-align: left; padding: 8px 10px; border-bottom: 1px solid #e2e8f0; }
    th { color:#475569; font-weight:600; background:#f8fafc; }
    .toolbar { display:flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 16px; }
    select, input[type="date"] { padding: 6px 8px; border:1px solid #cbd5e1; border-radius:8px; }
    button { padding: 8px 12px; border-radius:8px; border: 1px solid #0ea5e9; background:#0ea5e9; color:white; cursor:pointer; }
    button:disabled { opacity:.7; cursor:default; }
    .section { margin-top: 24px; }
    .nowrap { white-space: nowrap; }
    .ellipsis { max-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  </style>
</head>
<body>
  <h1>Tracking Dashboard</h1>

  <form class="toolbar" method="get">
    <label>Site
      <select name="site_key">
        <option value="">All</option>
        {% for sk in site_keys %}
          <option value="{{ sk }}" {% if active_site_key == sk %}selected{% endif %}>{{ sk }}</option>
        {% endfor %}
      </select>
    </label>
    <label>From
      <input type="date" name="from" value="{{ from }}">
    </label>
    <label>To
      <input type="date" name="to" value="{{ to }}">
    </label>
    <button type="submit">Apply</button>
    <button type="submit" name="export" value="csv">Export CSV</button>
  </form>

  <div class="grid grid-4">
    <div class="card kpi"><div>Total Events</div><div class="val">{{ total_events }}</div></div>
    <div class="card kpi"><div>Page Loads</div><div class="val">{{ page_loads }}</div></div>
    <div class="card kpi"><div>Form Submissions</div><div class="val">{{ form_submits }}</div></div>
    <div class="card kpi"><div>Unique Visitors</div><div class="val">{{ unique_visitors }}</div></div>
    <div class="card kpi"><div>Identified Users</div><div class="val">{{ identified_users }}</div></div>
    <div class="card kpi"><div>Events with Identity</div><div class="val">{{ events_with_identity }}</div></div>
    <div class="card kpi"><div>Identity Coverage</div><div class="val">{{ identity_coverage_pct }}%</div></div>
    <div class="card kpi"><div>Logins / Registrations</div><div class="val">{{ logins }} / {{ new_registrations }}</div></div>
  </div>

  <div class="grid grid-2 section">
    <div class="card">
      <h2>Events Over Time</h2>
      <canvas id="eventsChart" height="120"></canvas>
      <div class="muted">Daily totals from {{ from }} to {{ to }}</div>
    </div>
    <div class="card">
      <h2>New Leads</h2>
      <div class="kpi"><div class="val">{{ new_leads }}</div></div>
      <div class="muted">Leads created within selected range</div>
    </div>
  </div>

  <!-- Page & Navigation -->
  <div class="grid grid-2 section">
    <div class="card">
      <h2>Top Pages</h2>
      <table>
        <thead><tr><th>URL</th><th class="nowrap">Events</th></tr></thead>
        <tbody>
          {% for row in top_pages %}
            <tr>
              <td class="ellipsis"><a href="{{ row.page_url }}" target="_blank" rel="noopener">{{ row.page_url }}</a></td>
              <td class="nowrap">{{ row.events }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="2" class="muted">No data</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="card">
      <h2>Top Referrers</h2>
      <table>
        <thead><tr><th>Referrer</th><th class="nowrap">Events</th></tr></thead>
        <tbody>
          {% for row in top_referrers %}
            <tr>
              <td class="ellipsis">{{ row.ref }}</td>
              <td class="nowrap">{{ row.events }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="2" class="muted">No data</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Marketing -->
  <div class="grid grid-3 section">
    <div class="card">
      <h2>Top Sources</h2>
      <table>
        <thead><tr><th>Source</th><th>Events</th></tr></thead>
        <tbody>
          {% for row in top_sources %}
            <tr><td>{{ row.source|default:"—" }}</td><td>{{ row.events }}</td></tr>
          {% empty %}<tr><td colspan="2" class="muted">No data</td></tr>{% endfor %}
        </tbody>
      </table>
    </div>

    <div class="card">
      <h2>Top Mediums</h2>
      <table>
        <thead><tr><th>Medium</th><th>Events</th></tr></thead>
        <tbody>
          {% for row in top_mediums %}
            <tr><td>{{ row.medium|default:"—" }}</td><td>{{ row.events }}</td></tr>
          {% empty %}<tr><td colspan="2" class="muted">No data</td></tr>{% endfor %}
        </tbody>
      </table>
    </div>

    <div class="card">
      <h2>Top Campaigns</h2>
      <table>
        <thead><tr><th>Source</th><th>Campaign</th><th>Events</th></tr></thead>
        <tbody>
          {% for row in top_campaigns %}
            <tr>
              <td>{{ row.source|default:"—" }}</td>
              <td>{{ row.campaign|default:"—" }}</td>
              <td>{{ row.events }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="3" class="muted">No data</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Recent Searches (table only) -->
  <div class="section card">
    <h2>Recent Searches</h2>
    <table>
      <thead><tr><th>When</th><th>Field</th><th>Value</th><th>Page</th></tr></thead>
      <tbody>
        {% for r in recent_searches %}
          <tr>
            <td class="nowrap">{{ r.created_at }}</td>
            <td>{{ r.event_data__field__label|default:r.event_data__field__name }} ({{ r.event_data__field__type }})</td>
            <td>
              {% if r.event_data__field__masked %}
                [masked]
              {% else %}
                {{ r.event_data__field__value|default:"—" }}
              {% endif %}
            </td>
            <td class="ellipsis"><a href="{{ r.event_data__meta_url }}" target="_blank" rel="noopener">{{ r.event_data__meta_url }}</a></td>
          </tr>
        {% empty %}
          <tr><td colspan="4" class="muted">No recent searches</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Recent events (denormalized essentials) -->
  <div class="section card">
    <h2>Recent Events (last 10)</h2>
    <table>
      <thead>
        <tr>
          <th class="nowrap">When</th>
          <th>Type</th>
          <th>Event</th>
          <th>Page</th>
          <th>Title</th>
          <th>Referrer</th>
          <th>UTM</th>
          <th>Lang/TZ</th>
          <th>Viewport</th>
          <th>Screen</th>
          <th>Input</th>
          <th>Identity</th>
        </tr>
      </thead>
      <tbody>
        {% for e in recent_events %}
          <tr>
            <td class="nowrap">{{ e.created_at }}</td>
            <td>{{ e.event_type }}</td>
            <td>{{ e.evname|default:"—" }}</td>
            <td class="ellipsis"><a href="{{ e.page_url }}" target="_blank" rel="noopener">{{ e.page_url }}</a></td>
            <td class="ellipsis">{{ e.page_title_an|default:"—" }}</td>
            <td class="ellipsis">{{ e.ref|default:"—" }}</td>
            <td class="ellipsis">
              {% with s=e.utm_source_an m=e.utm_medium_an c=e.utm_campaign_an t=e.utm_term_an u=e.utm_content_an %}
                {{ s|default:"—" }}/{{ m|default:"—" }}/{{ c|default:"—" }}{% if t or u %} ({{ t|default:"—" }}, {{ u|default:"—" }}){% endif %}
              {% endwith %}
            </td>
            <td>{{ e.lang|default:"—" }}/{{ e.tz|default:"—" }}</td>
            <td>{{ e.vw|default:"—" }}×{{ e.vh|default:"—" }}</td>
            <td>{{ e.sw|default:"—" }}×{{ e.sh|default:"—" }} @{{ e.dpr|default:"—" }}</td>
            <td>
              {% if e.fld_label or e.fld_value %}
                {{ e.fld_label|default:"(field)" }}:
                {% if e.fld_masked %}[masked]{% else %}{{ e.fld_value|default:"—" }}{% endif %}
              {% else %}—{% endif %}
            </td>
            <td>
              {% if e.id_user_email or e.id_user_id or e.id_user_name %}
                {{ e.id_user_name|default:"" }} {{ e.id_user_email|default:"" }} {{ e.id_user_id|default:"" }}
              {% else %}—{% endif %}
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="12" class="muted">No events yet</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="section card">
    <h2>Recent Leads</h2>
    <table>
      <thead>
        <tr>
          <th>Name</th><th>Email</th><th>Phone</th><th>Address</th><th>Created</th>
        </tr>
      </thead>
      <tbody>
        {% for l in recent_leads %}
          <tr>
            <td>{{ l.first_name }} {{ l.last_name }}</td>
            <td>{{ l.email|default:"—" }}</td>
            <td>{{ l.phone|default:"—" }}</td>
            <td>{{ l.property_address|default:"—" }}</td>
            <td>{{ l.created_at }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="5" class="muted">No leads yet</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="section card">
    <h2>Recent Users</h2>
    <table>
      <thead>
        <tr>
          <th>User ID</th><th>Email</th><th>Name</th><th>First Seen</th><th>Last Seen</th>
        </tr>
      </thead>
      <tbody>
        {% for u in recent_users %}
          <tr>
            <td>{{ u.user_external_id|default:"—" }}</td>
            <td>{{ u.user_email|default:"—" }}</td>
            <td>{{ u.user_name|default:"—" }}</td>
            <td>{{ u.first_seen }}</td>
            <td>{{ u.last_seen }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="5" class="muted">No identified users yet</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const labels = JSON.parse('{{ days_json|safe }}');
    const data = JSON.parse('{{ counts_json|safe }}');

    const ctx = document.getElementById('eventsChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{ label: 'Events', data, tension: 0.3, fill: false }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });
  </script>
</body>
</html>
