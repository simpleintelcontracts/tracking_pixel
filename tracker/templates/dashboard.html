{# tracker/templates/dashboard.html #}
{% load static %}
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Tracking Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://unpkg.com/modern-normalize/modern-normalize.css" rel="stylesheet">
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; padding: 24px; color:#0f172a; }
    .grid { display: grid; gap: 16px; }
    .grid-4 { grid-template-columns: repeat(4,minmax(0,1fr)); }
    .grid-2 { grid-template-columns: repeat(2,minmax(0,1fr)); }
    .card { background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:16px; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .kpi { font-size: 14px; color:#475569; }
    .kpi .val { font-size: 28px; font-weight: 700; color:#0f172a; }
    .muted { color:#64748b; font-size: 12px; }
    h1 { font-size: 24px; margin: 0 0 16px; }
    h2 { font-size: 18px; margin: 0 0 12px; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { text-align: left; padding: 8px 10px; border-bottom: 1px solid #e2e8f0; }
    th { color:#475569; font-weight:600; background:#f8fafc; }
    .toolbar { display:flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 16px; }
    select, input[type="date"] { padding: 6px 8px; border:1px solid #cbd5e1; border-radius:8px; }
    button { padding: 8px 12px; border-radius:8px; border: 1px solid #0ea5e9; background:#0ea5e9; color:white; cursor:pointer; }
    button:disabled { opacity:.7; cursor:default; }
    .section { margin-top: 24px; }
  </style>
</head>
<body>
  <h1>Tracking Dashboard</h1>

  <form class="toolbar" method="get">
    <label>Site
      <select name="site_key">
        <option value="">All</option>
        {% for sk in site_keys %}
          <option value="{{ sk }}" {% if active_site_key == sk %}selected{% endif %}>{{ sk }}</option>
        {% endfor %}
      </select>
    </label>
    <label>From
      <input type="date" name="from" value="{{ from }}">
    </label>
    <label>To
      <input type="date" name="to" value="{{ to }}">
    </label>
    <button type="submit">Apply</button>
    <button type="submit" name="export" value="csv">Export CSV</button>
  </form>

  <div class="grid grid-4">
    <div class="card kpi"><div>Total Events</div><div class="val">{{ total_events }}</div></div>
    <div class="card kpi"><div>Page Loads</div><div class="val">{{ page_loads }}</div></div>
    <div class="card kpi"><div>Form Submissions</div><div class="val">{{ form_submits }}</div></div>
    <div class="card kpi"><div>Unique Visitors</div><div class="val">{{ unique_visitors }}</div></div>
    <div class="card kpi"><div>Identified Users</div><div class="val">{{ identified_users }}</div></div>
    <div class="card kpi"><div>New Registrations</div><div class="val">{{ new_registrations }}</div></div>
    <div class="card kpi"><div>Logins</div><div class="val">{{ logins }}</div></div>
  </div>

  <div class="grid grid-2 section">
    <div class="card">
      <h2>Events Over Time</h2>
      <canvas id="eventsChart" height="120"></canvas>
      <div class="muted">Daily totals from {{ from }} to {{ to }}</div>
    </div>
    <div class="card">
      <h2>New Leads</h2>
      <div class="kpi"><div class="val">{{ new_leads }}</div></div>
      <div class="muted">Leads created within selected range</div>
    </div>
  </div>

  <div class="grid grid-2 section">
    <div class="card">
      <h2>Top Pages</h2>
      <table>
        <thead><tr><th>URL</th><th>Events</th></tr></thead>
        <tbody>
          {% for row in top_pages %}
            <tr>
              <td style="max-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                <a href="{{ row.page_url }}" target="_blank" rel="noopener">{{ row.page_url }}</a>
              </td>
              <td>{{ row.events }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="2" class="muted">No data</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="card">
      <h2>Top Campaigns</h2>
      <table>
        <thead><tr><th>Source</th><th>Campaign</th><th>Events</th></tr></thead>
        <tbody>
          {% for row in top_campaigns %}
            <tr>
              <td>{{ row.source|default:"—" }}</td>
              <td>{{ row.campaign|default:"—" }}</td>
              <td>{{ row.events }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="3" class="muted">No data</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- NEW: Top Referrers & Languages -->
  <div class="grid grid-2 section">
    <div class="card">
      <h2>Top Referrers</h2>
      <table>
        <thead><tr><th>Referrer</th><th>Events</th></tr></thead>
        <tbody>
          {% for r in top_referrers %}
            <tr>
              <td style="max-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                <a href="{{ r.ref }}" target="_blank" rel="noopener">{{ r.ref }}</a>
              </td>
              <td>{{ r.events }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="2" class="muted">No data</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="card">
      <h2>Languages</h2>
      <table>
        <thead><tr><th>Language</th><th>Events</th></tr></thead>
        <tbody>
          {% for l in lang_breakdown %}
            <tr>
              <td>{{ l.lang }}</td>
              <td>{{ l.events }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="2" class="muted">No data</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- NEW: Device Mix & Top Searches -->
  <div class="grid grid-2 section">
    <div class="card">
      <h2>Device Mix (by viewport)</h2>
      <table>
        <thead><tr><th>Bucket</th><th>Events</th></tr></thead>
        <tbody>
          {% for d in device_mix %}
            <tr>
              <td>{{ d.bucket }}</td>
              <td>{{ d.events }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="2" class="muted">No data</td></tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="muted">Mobile: &lt;640px, Tablet: 640–1023px, Desktop: ≥1024px</div>
    </div>

    <div class="card">
      <h2>Top Searches</h2>
      <table>
        <thead><tr><th>Field</th><th>Query</th><th>Times</th></tr></thead>
        <tbody>
          {% for s in top_searches %}
            <tr>
              <td>{{ s.event_data__field__label|default:"Search" }}</td>
              <td style="max-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                {{ s.event_data__field__value }}
              </td>
              <td>{{ s.times }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="3" class="muted">No searches captured</td></tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="muted">Only explicit <code>search</code> events; sensitive fields are excluded.</div>
    </div>
  </div>

  <div class="section card">
    <h2>Recent Leads</h2>
    <table>
      <thead>
        <tr>
          <th>Name</th><th>Email</th><th>Phone</th><th>Address</th><th>Created</th>
        </tr>
      </thead>
      <tbody>
        {% for l in recent_leads %}
          <tr>
            <td>{{ l.first_name }} {{ l.last_name }}</td>
            <td>{{ l.email|default:"—" }}</td>
            <td>{{ l.phone|default:"—" }}</td>
            <td>{{ l.property_address|default:"—" }}</td>
            <td>{{ l.created_at }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="5" class="muted">No leads yet</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="section card">
    <h2>Recent Users</h2>
    <table>
      <thead>
        <tr>
          <th>User ID</th><th>Email</th><th>Name</th><th>First Seen</th><th>Last Seen</th>
        </tr>
      </thead>
      <tbody>
        {% for u in recent_users %}
          <tr>
            <td>{{ u.user_external_id|default:"—" }}</td>
            <td>{{ u.user_email|default:"—" }}</td>
            <td>{{ u.user_name|default:"—" }}</td>
            <td>{{ u.first_seen }}</td>
            <td>{{ u.last_seen }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="5" class="muted">No identified users yet</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const labels = JSON.parse('{{ days_json|safe }}');
    const data = JSON.parse('{{ counts_json|safe }}');

    const ctx = document.getElementById('eventsChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Events',
          data,
          tension: 0.3,
          fill: false,
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { maxRotation: 0, autoSkip: true } },
          y: { beginAtZero: true }
        }
      }
    });
  </script>
</body>
</html>
